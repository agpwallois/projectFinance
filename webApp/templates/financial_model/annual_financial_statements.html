<!-- Updated HTML structure for annual_financial_statements.html -->

<!-- Add the navigation controls banner before the tabs -->
<div class="excel-navigation-banner">
    <div class="excel-nav-controls">
        <span class="nav-instruction"><kbd>↑</kbd><kbd>↓</kbd><kbd>←</kbd><kbd>→</kbd> Navigate cells</span>
    </div>
</div>

<!-- Financial Statements Navigation -->
<ul class="nav nav-tabs scenario-nav-tabs" id="financialStatementsTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="financing-plan-tab" data-bs-toggle="tab" data-bs-target="#financing-plan" type="button" role="tab" aria-controls="financing-plan" aria-selected="true">
            Financing Plan
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="income-statement-tab" data-bs-toggle="tab" data-bs-target="#income-statement" type="button" role="tab" aria-controls="income-statement" aria-selected="true">
            Income Statement
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="operating-account-tab" data-bs-toggle="tab" data-bs-target="#operating-account" type="button" role="tab" aria-controls="operating-account" aria-selected="false">
            Operating Account
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="distribution-account-tab" data-bs-toggle="tab" data-bs-target="#distribution-account" type="button" role="tab" aria-controls="distribution-account" aria-selected="false">
            Distribution Account
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="balance-sheet-tab" data-bs-toggle="tab" data-bs-target="#balance-sheet" type="button" role="tab" aria-controls="balance-sheet" aria-selected="false">
            Balance Sheet
        </button>
    </li>
</ul>

<!-- Financial Statements Tab Content -->
<div class="tab-content" id="financialStatementsTabContent">
    <div class="tab-pane fade show active" id="financing-plan" role="tabpanel" aria-labelledby="financing-plan-tab">
        <div class="table-wrapper">
            <table class="table_annual excel-navigable" id="fs_financing_plan_table">
                <tbody id="fs_financing_plan"></tbody>
            </table>
        </div>
    </div>
    <div class="tab-pane fade" id="income-statement" role="tabpanel" aria-labelledby="income-statement-tab">
        <div class="table-wrapper">
            <table class="table_annual excel-navigable">
                <tbody id="annual_IS"></tbody>
            </table>
        </div>
    </div>

    <div class="tab-pane fade" id="operating-account" role="tabpanel" aria-labelledby="operating-account-tab">
        <div class="table-wrapper">
            <table class="table_annual excel-navigable">
                <tbody id="annual_op_account"></tbody>
            </table>
        </div>
    </div>
    <div class="tab-pane fade" id="distribution-account" role="tabpanel" aria-labelledby="distribution-account-tab">
        <div class="table-wrapper">
            <table class="table_annual excel-navigable">
                <tbody id="annual_distr_account"></tbody>
            </table>
        </div>
    </div>
    <div class="tab-pane fade" id="balance-sheet" role="tabpanel" aria-labelledby="balance-sheet-tab">
        <div class="table-wrapper">
            <table class="table_annual excel-navigable">
                <tbody id="annual_balance_sheet"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- JavaScript for Excel-like Navigation -->
<script>
$(document).ready(function() {
    let currentRow = 1;
    let currentCol = 1;
    let currentTable = null;
    
    // Initialize navigation after a short delay to ensure tables are populated
    setTimeout(function() {
        initializeNavigation();
    }, 100);
    
    // Also try to initialize immediately
    initializeNavigation();
    
    // Reinitialize when switching tabs
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function() {
        setTimeout(function() {
            initializeNavigation();
        }, 50);
    });
    
    function initializeNavigation() {
        // Find the active table
        currentTable = $('.tab-pane.active .excel-navigable').first();
        if (currentTable.length === 0 || currentTable.find('td').length === 0) {
            // If no cells found, try again after a delay
            setTimeout(initializeNavigation, 200);
            return;
        }
        
        // Add navigation attributes to all cells
        currentTable.find('td').each(function() {
            const $cell = $(this);
            const row = $cell.parent().index() + 1;
            const col = $cell.index() + 1;
            $cell.attr('data-nav-row', row);
            $cell.attr('data-nav-col', col);
        });
        
        // Select first cell
        currentRow = 1;
        currentCol = 1;
        selectCell(currentRow, currentCol);
    }
    
    function selectCell(row, col) {
        if (!currentTable || currentTable.length === 0) return;
        
        const $cell = currentTable.find(`td[data-nav-row="${row}"][data-nav-col="${col}"]`);
        if ($cell.length === 0) return;
        
        // Remove previous selection
        $('.excel-navigable td').removeClass('excel-selected');
        
        // Add selection to new cell
        $cell.addClass('excel-selected');
        
        // Update current position
        currentRow = row;
        currentCol = col;
        
        // Ensure cell is visible
        ensureCellVisible($cell);
    }
    
    function ensureCellVisible($cell) {
        const container = $cell.closest('.tab-pane');
        if (!container.length) return;
        
        const cellTop = $cell.offset().top - container.offset().top;
        const cellBottom = cellTop + $cell.outerHeight();
        const containerHeight = container.height();
        const scrollTop = container.scrollTop();
        
        if (cellTop < 0) {
            container.scrollTop(scrollTop + cellTop - 50);
        } else if (cellBottom > containerHeight) {
            container.scrollTop(scrollTop + cellBottom - containerHeight + 50);
        }
    }
    
    function getTableDimensions() {
        if (!currentTable || currentTable.length === 0) return { rows: 0, cols: 0 };
        
        const rows = currentTable.find('tr').length;
        let maxCols = 0;
        
        // Find the maximum number of columns across all rows
        currentTable.find('tr').each(function() {
            const cols = $(this).find('td').length;
            if (cols > maxCols) maxCols = cols;
        });
        
        return { rows, cols: maxCols };
    }
    
    // Keyboard navigation handler
    $(document).on('keydown', function(e) {
        if (!currentTable || !currentTable.is(':visible') || currentTable.find('td').length === 0) return;
        
        // Check if user is typing in an input field
        if ($(e.target).is('input, select, textarea')) return;
        
        const { rows, cols } = getTableDimensions();
        let handled = true;
        
        switch(e.key) {
            case 'ArrowUp':
                if (currentRow > 1) {
                    selectCell(currentRow - 1, currentCol);
                }
                break;
                
            case 'ArrowDown':
                if (currentRow < rows) {
                    selectCell(currentRow + 1, currentCol);
                }
                break;
                
            case 'ArrowLeft':
                if (currentCol > 1) {
                    selectCell(currentRow, currentCol - 1);
                }
                break;
                
            case 'ArrowRight':
                if (currentCol < cols) {
                    selectCell(currentRow, currentCol + 1);
                }
                break;
                
            default:
                handled = false;
        }
        
        if (handled) {
            e.preventDefault();
        }
    });
    
    // Click to select cell
    $(document).on('click', '.excel-navigable td', function() {
        const $this = $(this);
        const row = $this.parent().index() + 1;
        const col = $this.index() + 1;
        
        currentTable = $this.closest('.excel-navigable');
        
        // Re-initialize attributes for this table
        currentTable.find('td').each(function() {
            const $cell = $(this);
            const r = $cell.parent().index() + 1;
            const c = $cell.index() + 1;
            $cell.attr('data-nav-row', r);
            $cell.attr('data-nav-col', c);
        });
        
        selectCell(row, col);
    });
    
    // Also listen for when table content changes
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                setTimeout(initializeNavigation, 100);
            }
        });
    });
    
    // Observe changes in all table bodies
    const tableIds = ['annual_IS', 'annual_op_account', 'annual_distr_account', 'annual_balance_sheet'];
    tableIds.forEach(function(id) {
        const element = document.getElementById(id);
        if (element) {
            observer.observe(element, { childList: true, subtree: true });
        }
    });
});
</script>