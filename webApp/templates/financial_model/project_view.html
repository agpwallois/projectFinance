{% extends "base.html" %}
{% load static %}

{% block content %}
<form method="POST" id="post-form">{% csrf_token %}

    <!-- Project Header - Positioned right after header but before sidebar and content -->
    <div class="project-header">
        <a href="{% url 'project_list' %}" style="text-decoration: none; margin-right: 10px; font-weight: bold;">&#8592;</a>
        <h1 id="project_name"> Project: {{ project.name }} ({{ project.technology }})</h1>
        <div class="metric-value" id="metric-status">{{ project.project_status }}</div>
    </div>
    




    <!-- Include Sidebar -->
    {% include 'financial_model/sidebar.html' %}

    <div id="content">

<div id="content-box">
    <!-- Project Overview Section -->
     
    <div class="box-wrapper project-overview-wrapper" id="overview-wrapper">
        <h2>Project Overview</h2>
        <div class="overview-metrics-row">
            <!-- Total Investment Box -->
             
            <div class="overview-metrics-column">
                <div class="overview-box">
                    <div class="metric-value" id="capacity"></div>
                    <h4>Capacity (kWp)</h4>
 
                </div>
            </div>
            
            <!-- Equity IRR Box -->
            <div class="overview-metrics-column">
                <div class="overview-box">
                    <div class="metric-value" id="total_uses"></div>
                    <h4>Total Project Costs (kEUR)</h4>
    
                </div>
            </div>
            
            <!-- Min DSCR Box -->
            <div class="overview-metrics-column">
                <div class="overview-box">
                    <div class="metric-value" id="sponsor_IRR"></div>
                    <h4>Sponsor Case Equity IRR</h4>
 
                </div>
            </div>

            <!-- Status Box -->
            <div class="overview-metrics-column">
                <div class="overview-box">
                    <div class="metric-value" id="gearing"></div>
                     <h4>Senior Debt Gearing</h4>
    
                </div>
            </div>
            
            <!-- Status Box -->
            <div class="overview-metrics-column">
                <div class="overview-box">
                    <div class="metric-value" id="lender_DSCR"></div>
                     <h4>Lender Case Min DSCR</h4>
    
                </div>
            </div>




        </div>
    </div>



</div>


<div id="content-box">

    <div class="dashboard-container">
        <h2>Scenario Selection</h2>
     <!-- Scenario Analysis Section -->
        <div class="box" id="summary-sensitivities">
            <!-- Navigation tabs for Sponsor Case and Lender Case -->
        <!-- Modal -->
        <div id="loading-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
          <div style="position:absolute; top:40%; left:50%; transform:translate(-50%, -50%); background:white; padding:30px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.3); font-size:18px;">
            Creating scenarios... Please wait 5 seconds.
          </div>
        </div>

        <div class="navigation-container">
            <div class="nav-container">
                <nav>
                <ul class="nav nav-tabs scenario-nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#sponsor-case-tab" data-bs-toggle="tab">
                        Sponsor Scenarios&nbsp;<br>
                        <small>(<span id="sponsor_prod_choice" class="d-inline"></span>, <span id="sponsor_mkt_price_choice" class="d-inline"></span> prices)</small>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#lender-case-tab" data-bs-toggle="tab">
                        Lender Scenarios&nbsp;<br>
                        <small>(<span id="lender_prod_choice" class="d-inline"></span>, <span id="lender_mkt_price_choice" class="d-inline"></span> prices)</small>
                        </a>
                    </li>
                </ul>
                </nav>
            </div>
</div>
            <div class="tab-content">
                <!-- Sponsor Case Tab Content -->
                <div class="tab-pane fade show active" id="sponsor-case-tab">


                    <div class="summary-container">
                        <div class="summary-scenario-left">
                            <table class="dashboard-sensi-table" id="dashboard-sensi-table-input-sponsor">
                                <thead>
                                    <tr>
                                        <th>Selection</th>
                                        <th>Scenario</th>
                                        <th>Sensitivity</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="sponsor_base_case" checked>
                                        </td>
                                        <td>Base Case</td>
                                        <td>-</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>

                            <table class="dashboard-sensi-table" id="dashboard-sensi-table-input-sensi-sponsor">
                                <tbody>
                                    <tr>
                                     <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="sponsor_sensi_prod">
                                        </td>

                                        <td>Production</td>
                                        <td>{{ project_form.sensi_production_sponsor }}</td>
                                        <td><div id="sponsor_sensi_production"></div></td>
                                    </tr>
                                    <tr>
                                    <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="sponsor_sensi_inf">
                                        </td>

                                        <td>Inflation</td>


                                        <td>{{ project_form.sensi_inflation_sponsor }}</td>
                                        <td><div id="sponsor_sensi_inflation"></div></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="sponsor_sensi_opex">
                                        </td>

                                        <td>Operating costs</td>
                                        <td>{{ project_form.sensi_opex_sponsor }}</td>
                                        <td><div id="sponsor_sensi_opex"></div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="summary-scenario-right">
                            <table class="dashboard-sensi-table">
                                <tbody id="sponsor_summary_sensi"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Lender Case Tab Content -->
                <div class="tab-pane fade" id="lender-case-tab">


                    <div class="summary-container">
                        <div class="summary-scenario-left">
                            <table class="dashboard-sensi-table" id="dashboard-sensi-table-input">
                                <thead>
                                    <tr>
                                        <th>Selection</th>
                                        <th>Scenario</th>
                                        <th>Sensitivity</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="lender_base_case">
                                        </td>

                                        <td>Base Case</td>
                                        <td>-</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>

                            <table class="dashboard-sensi-table" id="dashboard-sensi-table-input-sensi">
                                <tbody>
                                    <tr>
                                        <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="lender_sensi_prod">
                                        </td>

                                        <td>Production</td>
                                        <td>{{ project_form.sensi_production }}</td>
                                        <td><div id="sensi_production"></div></td>
                                    </tr>
                                    <tr>
                                       <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="lender_sensi_inf">
                                        </td>

                                        <td>Inflation</td>
                                        <td>{{ project_form.sensi_inflation }}</td>
                                        <td><div id="sensi_inflation"></div></td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <input class="form-check-input" type="radio" name="scenarios" value="lender_sensi_opex">
                                        </td>

                                        <td>Operating costs</td>
                                        <td>{{ project_form.sensi_opex }}</td>
                                        <td><div id="sensi_opex"></div></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="summary-scenario-right">
                            <table class="dashboard-sensi-table">
                                <tbody id="summary_sensi"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



        <div id="content-box">

<div class="dashboard-container">
    <h2>Selected Scenario Overview</h2>
    <!-- Navigation Container - Below project header, containing nav tabs and toggle -->


            <div class="tab-content">
                

                    {% include 'financial_model/dashboard.html' %}
      



                
            </div>
        </div>
    </div>

    </div>

<!-- Floating expand button (shown when sidebar is collapsed) -->
<button type="button" class="sidebar-expand-btn" id="sidebarExpandBtn" title="Expand sidebar">
    ←
</button>

</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Allow clicking anywhere on row to select radio
    $(document).on('click', '.dashboard-sensi-table tr', function(e) {
        // Don't trigger if clicking directly on the radio button or if it's a header row
        if (e.target.type === 'radio' || $(this).find('th').length > 0) return;
        
        const radio = $(this).find('input[type="radio"][name="scenarios"]');
        if (radio.length > 0 && !radio.is(':checked')) {
            radio.click();
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebarWrapper = document.getElementById('sidebar-wrapper');
    const contentArea = document.getElementById('content');
    const collapseBtn = document.getElementById('sidebarCollapseBtn');
    const expandBtn = document.getElementById('sidebarExpandBtn');
    const body = document.body;

    function collapseSidebar() {
        sidebarWrapper.classList.add('sidebar-collapsed');
        contentArea.classList.add('sidebar-collapsed');
        body.classList.add('sidebar-collapsed');
        localStorage.setItem('sidebarCollapsed', 'true');
    }

    function expandSidebar() {
        sidebarWrapper.classList.remove('sidebar-collapsed');
        contentArea.classList.remove('sidebar-collapsed');
        body.classList.remove('sidebar-collapsed');
        localStorage.setItem('sidebarCollapsed', 'false');
    }

    collapseBtn.addEventListener('click', collapseSidebar);
    expandBtn.addEventListener('click', expandSidebar);

    // Optional: Keyboard shortcut (Ctrl+B)
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'b') {
            e.preventDefault();
            if (sidebarWrapper.classList.contains('sidebar-collapsed')) {
                expandSidebar();
            } else {
                collapseSidebar();
            }
        }
    });

    // Restore saved state
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
        collapseSidebar();
    }
});
</script>



<!-- AJAX Scripts - Only loaded on project view page -->
<script src="{% static 'financial_model/ajax/process_get_post_form_with_ajax.js' %}"></script>
<script src="{% static 'financial_model/ajax/set_up_sensitivities_form_submission_listeners.js' %}"></script>
<script src="{% static 'financial_model/ajax/hide_sidebar_construction_months_fields.js' %}"></script>
<script src="{% static 'financial_model/ajax/hide_sidebar_mkt_prices_years_fields.js' %}"></script>
<script src="{% static 'financial_model/ajax/hide_sidebar_solar_or_wind_fields.js' %}"></script>


<script src="{% static 'financial_model/ajax/build_computation_table.js' %}"></script>



<script src="{% static 'financial_model/ajax/build_dashboard_cards.js' %}"></script>
<script src="{% static 'financial_model/ajax/build_fs_financial_statements.js' %}"></script>
<script src="{% static 'financial_model/ajax/build_fs_financing_plan.js' %}"></script>
<script src="{% static 'financial_model/ajax/build_fs_balance_sheet.js' %}"></script>

<script src="{% static 'financial_model/ajax/build_charts.js' %}"></script>
<script src="{% static 'financial_model/ajax/update_dashboard_and_sidebar_cards.js' %}"></script>

{% endblock %}